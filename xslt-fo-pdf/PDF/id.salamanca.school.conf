<VirtualHost *:80>
    ServerName          id.salamanca.school
    ServerAdmin         admin@salamanca.school

    ErrorLog  /var/log/apache2/id.salamanca.school-error.log
    CustomLog /var/log/apache2/id.salamanca.school-access.log combined

    ProxyRequests       Off                                # We don't want to act as (open) forward proxy
    ProxyTimeout        432000

    RewriteEngine On
    RewriteCond %{HTTP_USER_AGENT} OPPO.A33|MJ12bot [NC]
    RewriteRule ^ - [F,L]
    RewriteCond %{HTTPS} !=On
    RewriteCond %{REQUEST_URI} !^/.well-known
    RewriteRule ^\/?(.*) https://id.salamanca.school/$1 [R=301,L]

    # for letsencrypt acme challenge:
    Alias /.well-known "/var/www/vhosts/.well-known"
    <Directory "/var/www/vhosts/.well-known">
        Require all granted
        AllowOverride All
        AddDefaultCharset Off
        Header set Content-Type "text/plain"
    </Directory>
</VirtualHost>

<VirtualHost *:443>
    ServerName          id.salamanca.school
    ServerAdmin         admin@salamanca.school

    ErrorLog  /var/log/apache2/id.salamanca.school-error.log
    CustomLog /var/log/apache2/id.salamanca.school-access.log combined

    SSLEngine on
SSLCertificateFile /etc/letsencrypt/live/salamanca.school/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/salamanca.school/privkey.pem
    SSLProtocol all -SSLv3
    SSLHonorCipherOrder On
    SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AE:RSA+AES:!aNULL:!MD5:!DSS
    SSLCompression Off

    SSLProxyEngine On
    SSLProxyProtocol ALL -SSLv3
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    ProxyRequests       Off                                     # We don't want to act as (open) forward proxy
    ProxyTimeout        432000

    # forward id to the restxq servlet, not to the main app
    ProxyPass           /   http://localhost:8080/exist/restxq/
    ProxyPassReverse    /   http://localhost:8080/exist/restxq/
    ProxyPassReverse    /   https://localhost:8443/exist/restxq/
</VirtualHost>
